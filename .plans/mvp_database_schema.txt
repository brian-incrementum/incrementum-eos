-- ============================================
-- ENUM TYPES
-- ============================================

-- Metric cadence (how often it is updated)
create type public.metric_cadence as enum ('weekly', 'monthly', 'quarterly');

-- How the metric is scored against its target
create type public.metric_scoring_mode as enum ('at_least', 'at_most', 'between');

-- Scorecard type
create type public.scorecard_type as enum ('personal', 'team');

-- Role of a user on a team
create type public.team_member_role as enum ('owner', 'member');

-- Role of a user on a scorecard
create type public.scorecard_member_role as enum ('owner', 'editor', 'viewer');



-- ============================================
-- PROFILES
-- ============================================

create table public.profiles (
  id uuid primary key references auth.users(id) on delete cascade,
  full_name text,
  email text unique,
  avatar_url text,
  is_active boolean not null default true,
  created_at timestamptz not null default now(),
  updated_at timestamptz not null default now()
);

-- Auto-create profile when a user signs in with Google
create or replace function public.handle_new_user()
returns trigger as $$
begin
  insert into public.profiles (id, full_name, email, avatar_url)
  values (
    new.id,
    coalesce(
      new.raw_user_meta_data->>'full_name',
      new.raw_user_meta_data->>'name'
    ),
    new.email,
    new.raw_user_meta_data->>'avatar_url'
  )
  on conflict (id) do update
  set
    full_name  = excluded.full_name,
    email      = excluded.email,
    avatar_url = excluded.avatar_url,
    updated_at = now();

  return new;
end;
$$ language plpgsql security definer;

create trigger on_auth_user_created
after insert on auth.users
for each row
execute procedure public.handle_new_user();



-- ============================================
-- TEAMS & TEAM MEMBERS
-- ============================================

create table public.teams (
  id uuid primary key default gen_random_uuid(),
  name text not null,
  description text,
  created_by uuid not null references public.profiles(id),
  created_at timestamptz not null default now(),
  archived_at timestamptz
);

create table public.team_members (
  id uuid primary key default gen_random_uuid(),
  team_id uuid not null references public.teams(id) on delete cascade,
  user_id uuid not null references public.profiles(id) on delete cascade,
  role public.team_member_role not null default 'member',
  created_at timestamptz not null default now(),
  unique (team_id, user_id)
);



-- ============================================
-- SCORECARDS & SCORECARD MEMBERS
-- ============================================

create table public.scorecards (
  id uuid primary key default gen_random_uuid(),
  name text not null,
  type public.scorecard_type not null default 'personal',
  owner_user_id uuid not null references public.profiles(id),
  team_id uuid references public.teams(id),
  is_active boolean not null default true,
  created_at timestamptz not null default now(),
  created_by uuid not null references public.profiles(id)
);

-- Ensure team_id is set when type = 'team'
alter table public.scorecards
  add constraint scorecards_team_required_for_team_type
  check (
    (type = 'personal' and team_id is null)
    or
    (type = 'team' and team_id is not null)
  );

create table public.scorecard_members (
  id uuid primary key default gen_random_uuid(),
  scorecard_id uuid not null references public.scorecards(id) on delete cascade,
  user_id uuid not null references public.profiles(id) on delete cascade,
  role public.scorecard_member_role not null default 'viewer',
  created_at timestamptz not null default now(),
  unique (scorecard_id, user_id)
);



-- ============================================
-- METRICS
-- ============================================

create table public.metrics (
  id uuid primary key default gen_random_uuid(),
  scorecard_id uuid not null references public.scorecards(id) on delete cascade,
  name text not null,
  description text,
  cadence public.metric_cadence not null default 'weekly',
  unit text,  -- examples: '$', '%', 'count'

  -- Scoring configuration
  scoring_mode public.metric_scoring_mode not null default 'at_least',

  -- For scoring_mode = 'at_least' or 'at_most'
  target_value numeric,

  -- For scoring_mode = 'between'
  target_min numeric,
  target_max numeric,

  owner_user_id uuid references public.profiles(id),
  display_order int not null default 0,
  is_active boolean not null default true,
  created_at timestamptz not null default now()
);



-- ============================================
-- METRIC ENTRIES
-- ============================================

create table public.metric_entries (
  id uuid primary key default gen_random_uuid(),
  metric_id uuid not null references public.metrics(id) on delete cascade,

  -- Start date of the period
  -- Weekly = Monday of that week
  -- Monthly = 1st of the month
  -- Quarterly = 1st of the quarter
  period_start date not null,

  value numeric not null,
  note text,

  created_by uuid references public.profiles(id),
  created_at timestamptz not null default now(),

  unique (metric_id, period_start)
);



-- ============================================
-- INDEXES
-- ============================================

create index idx_scorecards_owner on public.scorecards(owner_user_id);
create index idx_scorecards_team on public.scorecards(team_id);

create index idx_metrics_scorecard on public.metrics(scorecard_id);
create index idx_metric_entries_metric on public.metric_entries(metric_id);
create index idx_metric_entries_period on public.metric_entries(period_start);